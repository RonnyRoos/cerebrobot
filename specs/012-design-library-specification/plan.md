# Implementation Plan: Design Library for Cerebrobot

**Branch**: `012-design-library-specification` | **Date**: 2025-11-02 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/012-design-library-specification/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command following the workflow defined in `.specify/templates/commands/plan.md`.

## Summary

Build a chatbot-specific design system (`@workspace/ui`) with React components optimized for chat UX: MessageBubble (user/agent variants with markdown rendering), CodeBlock (syntax highlighting + copy button), TypingIndicator, Avatar, Timestamp, and CopyButton. The system provides chat-semantic color tokens (user message, agent message, code block, timestamp) and typography optimized for long-form AI responses (16-18px body, 1.6 line height, heading hierarchy, monospace code). Components follow ShadCN patterns (source files operators can customize), support light/dark themes via Tailwind class strategy + React Context, and persist preferences to localStorage. Technical approach uses react-markdown + remark-gfm for rendering, react-syntax-highlighter with Prism backend for code, class-variance-authority for type-safe variants, and native Intl APIs for timestamp formatting (zero external dependencies).

## Technical Context

**Language/Version**: TypeScript 5.5+, React 18+, Vite (SPA, not SSR)  
**Primary Dependencies**: react-markdown 9+, remark-gfm, react-syntax-highlighter (Prism backend), Tailwind CSS, ShadCN UI components, class-variance-authority  
**Storage**: N/A (purely frontend UI component library, no database)  
**Testing**: Vitest + React Testing Library for unit tests, manual smoke tests for visual verification  
**Target Platform**: Modern browsers (Chrome, Firefox, Safari latest 2 versions), no IE11 support  
**Project Type**: Monorepo package (`packages/ui`) consumed by web app (`apps/client`)  
**Performance Goals**: <100ms render for MessageBubble, 60fps animations for TypingIndicator, lazy-loaded syntax highlighter languages (~2KB each)  
**Constraints**: WCAG AA contrast (4.5:1 minimum) for text-on-background, max 65ch line length for readability, 65% viewport max-width for message bubbles  
**Scale/Scope**: 6 chat components (P1: MessageBubble, CodeBlock, Avatar; P2: TypingIndicator, Timestamp, CopyButton), 9 chat-semantic color tokens, chat-optimized typography scale

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### ✅ I. Hygiene-First Development
- **Status**: PASS  
- **Evidence**: Will implement `pnpm lint`, `pnpm format:write`, `pnpm test` scripts in `packages/ui/package.json`  
- **Plan**: Add ESLint + Prettier configs matching monorepo root, Vitest for component tests

### ✅ II. Transparency & Inspectability
- **Status**: PASS  
- **Evidence**: All component props clearly typed and documented, theme tokens exposed as CSS custom properties  
- **Plan**: Export all TypeScript interfaces, document component APIs in contracts/, provide theme token reference

### ✅ III. Type Safety & Testability
- **Status**: PASS  
- **Evidence**:  
  - No `any` types (strict TypeScript)
  - Discriminated unions for variants (`sender: 'user' | 'agent'`, not `isUser: boolean`)
  - Dependency injection (markdown renderer, syntax highlighter configurable via props)
  - 3-tier testing: (1) Unit tests for components with React Testing Library, (2) No Postgres needed (pure UI), (3) Manual smoke tests for visual verification
- **Plan**: Mock markdown renderer and syntax highlighter in unit tests for speed, create visual test page in apps/client

### ✅ IV. Incremental & Modular Development
- **Status**: PASS  
- **Evidence**: P1 (MessageBubble, CodeBlock, Avatar, colors, typography) → P2 (TypingIndicator, Timestamp, dark mode) → P3 (CopyButton)  
- **Plan**: Each component independently testable, commit after hygiene loop passes per increment

### ✅ V. Stack Discipline
- **Status**: PASS  
- **Evidence**: Using approved React 18+, TypeScript 5.5+, Tailwind CSS, Vite  
- **Justification**: New dependencies (react-markdown, react-syntax-highlighter, class-variance-authority) chosen via research.md, aligned with ShadCN ecosystem, no version conflicts

### ✅ VI. Configuration Over Hardcoding
- **Status**: PASS  
- **Evidence**: Theme via localStorage (`cerebrobot-theme` key), swappable markdown/syntax renderers via component props, CSS custom properties for colors  
- **Plan**: ThemeProvider + useTheme hook for runtime config, escape hatches via className props

### ✅ VII. Operator-Centric Design
- **Status**: PASS  
- **Evidence**: ShadCN philosophy—components are source files operators own and customize (not npm black boxes), simple setup (< 15 min per quickstart.md), clear prop documentation  
- **Plan**: Quickstart guide with copy-paste examples, components.json for ShadCN CLI customization

### ✅ VIII. MCP Server Utilization
- **Status**: PASS (plan execution phase)  
- **Evidence**:  
  - Used SequentialThinking MCP for planning this implementation (12-step breakdown)
  - Used Context7 MCP for react-markdown and Tailwind best practices research
  - Will use Serena MCP for code navigation during implementation
  - Will use Playwright MCP for visual regression testing if needed
- **Plan**: Reference MCP servers during implementation for library API verification

**Gate Result**: ✅ ALL CHECKS PASS — Proceed to Phase 0 research

## Project Structure

### Documentation (this feature)

```text
specs/012-design-library-specification/
├── spec.md              # Feature specification (user stories, requirements, success criteria)
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (technology decisions: react-markdown, syntax highlighter, ShadCN setup, dark mode, timestamps)
├── data-model.md        # Phase 1 output (TypeScript interfaces for MessageBubble, CodeBlock, Avatar, TypingIndicator, Timestamp, CopyButton)
├── quickstart.md        # Phase 1 output (installation guide, setup steps, first component usage)
├── contracts/           # Phase 1 output (API documentation)
│   ├── component-api.md    # Component props, usage examples, performance characteristics
│   └── theme-tokens.md     # CSS custom properties reference, color/typography tokens
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
packages/ui/                       # NEW: Design system package
├── components.json                # ShadCN CLI config
├── tailwind.config.ts             # Shared theme tokens (chat colors, typography)
├── tsconfig.json                  # TypeScript config (extends monorepo base)
├── package.json                   # exports: { ".": "./src/index.ts", "./theme": "./src/theme/globals.css" }
└── src/
    ├── index.ts                   # Re-export all components and types
    ├── chat/                      # Chat-specific components (NEW)
    │   ├── message-bubble.tsx     # P1: User/agent message with markdown
    │   ├── code-block.tsx         # P1: Syntax highlighting + copy button
    │   ├── avatar.tsx             # P1: Image or initials fallback
    │   ├── typing-indicator.tsx   # P2: Animated dots/pulse
    │   ├── timestamp.tsx          # P2: Relative/absolute time
    │   └── copy-button.tsx        # P3: Clipboard copy utility
    ├── primitives/                # ShadCN base components (if needed)
    │   ├── button.tsx             # Generic button (from ShadCN)
    │   └── ...                    # Other primitives as needed
    ├── utils/
    │   ├── cn.ts                  # Tailwind merge utility (clsx + tailwind-merge)
    │   ├── theme.tsx              # ThemeProvider + useTheme hook
    │   ├── markdown.ts            # Markdown component customization
    │   └── format-timestamp.ts    # Timestamp formatting (native Intl)
    └── theme/
        ├── globals.css            # CSS custom properties, Tailwind imports
        └── chat-colors.css        # Chat-specific color token definitions

apps/client/                       # UPDATED: Consumer of @workspace/ui
├── src/
│   ├── main.tsx                   # Wrap in ThemeProvider, import '@workspace/ui/theme'
│   └── ...
└── tailwind.config.ts             # Extend packages/ui/tailwind.config.ts via presets

tests/                             # Unit tests for UI components
└── packages/ui/
    └── src/
        └── chat/
            ├── message-bubble.test.tsx
            ├── code-block.test.tsx
            └── ...
```

**Structure Decision**: Web application monorepo with dedicated UI package. Chose this structure because:
1. `packages/ui` isolates design system as reusable dependency (follows Constitution VII: Operator-Centric)
2. ShadCN pattern (components as source files) enables operator customization without forking
3. Tailwind config sharing via `presets` allows apps/client to inherit chat colors/typography while adding app-specific overrides
4. Single source of truth for chat components prevents drift across features
5. Testable independently of consuming applications (Constitution III: Testability)

## Complexity Tracking

> **No violations detected — this section intentionally left empty**

All Constitution principles satisfied without exceptions:
- No additional projects beyond approved monorepo structure
- No unnecessary abstractions (no Repository pattern, no custom state management—uses React Context)
- No unapproved libraries (all dependencies justified in research.md)
- Testing follows mandated 3-tier strategy (unit tests + manual smoke tests, no Postgres needed)
- No `any` types permitted (strict TypeScript)

**Rationale for KISS compliance**: Design system uses native browser APIs (Intl for timestamps, Clipboard API for copy), established patterns (ShadCN component structure, Tailwind utility classes), and minimal dependencies (react-markdown + syntax highlighter are industry-standard choices, not reinventing markdown parsing).
