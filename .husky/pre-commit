#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Design System Enforcement Checks
# Prevent legacy CSS patterns from being committed

echo "ğŸ” Running design system enforcement checks..."

# Detect CSS imports in client components (exclude design library theme)
STAGED_TSX=$(git diff --cached --name-only --diff-filter=ACM | grep "apps/client/.*\.tsx$" || true)

if [ -n "$STAGED_TSX" ]; then
  # Check for CSS imports
  CSS_IMPORTS=$(echo "$STAGED_TSX" | xargs grep -l "import.*\.css" 2>/dev/null || true)
  if [ -n "$CSS_IMPORTS" ]; then
    echo "âŒ CSS imports detected in client components:"
    echo "$CSS_IMPORTS"
    echo "ğŸ’¡ Use design system primitives from @workspace/ui instead."
    exit 1
  fi

  # Check for inline styles
  INLINE_STYLES=$(echo "$STAGED_TSX" | xargs grep -l 'style={{' 2>/dev/null || true)
  if [ -n "$INLINE_STYLES" ]; then
    echo "âŒ Inline styles detected:"
    echo "$INLINE_STYLES"
    echo "ğŸ’¡ Use design system props or CSS variables instead."
    exit 1
  fi

  # Check for hardcoded colors (hex, rgb, rgba)
  HARDCODED_COLORS=$(echo "$STAGED_TSX" | xargs grep -E "#[0-9a-fA-F]{6}|rgb\(|rgba\(" 2>/dev/null || true)
  if [ -n "$HARDCODED_COLORS" ]; then
    echo "âŒ Hardcoded colors detected:"
    echo "$HARDCODED_COLORS"
    echo "ğŸ’¡ Use design tokens (CSS variables) instead."
    exit 1
  fi
fi

echo "âœ… Design system checks passed"

# Run hygiene loop
echo "ğŸ”§ Running hygiene loop (lint â†’ format â†’ test)..."
pnpm lint && pnpm format:write && pnpm test
